name: Full deployment workflow with security scan

on:
  push:
    branches: 
      - main

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  issues: write

jobs:
  security-scan:
    name: gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        with:
          scan-mode: all
          report-format: sarif
          report-path: gitleaks.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}

      - name: Upload Gitleaks SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gitleaks.sarif
            
      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
        continue-on-error: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  jobs:
    Build :
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::674845781849:role/github
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name : Build, Tag, and Push Docker Image
        run: |
          docker build -t dashboard:${{ github.run_number }} .
          docker login --username AWS --password $(aws ecr get-login-password --region ${{ env.AWS_REGION }}) $ECR_REGISTRY
          docker tag dashboard:${{ github.run_number }} $ECR_REGISTRY/dashboard:${{ github.run_number }}
          docker push $ECR_REGISTRY/dashboard:${{ github.run_number }}
       
      - name : trivy scan
        uses: aquasecurity/trivy-action@v0.4.0
        with:
          image-ref: $ECR_REGISTRY/dashboard:${{ github.run_number }}
          format: sarif
          output: trivy-scan.sarif
          severity-threshold: HIGH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2  
        with:
          sarif_file: trivy-scan.sarif

    jobs:
      Deploy :
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS credentials (OIDC)
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: arn:aws:iam::674845781849:role/github
            aws-region: ${{ env.AWS_REGION }}

        - name: Deploy to EC2 Instance
          run: |
            aws ssm send-command \
              --document-name "${{ env.SSM_DOCUMENT_NAME }}" \
              --targets "Key=instanceids,Values=${{ env.INSTANCE_ID }}" \
              --comment "Deploying application" \
              --parameters '{"ImageTag":["${{ env.IMAGE_TAG }}"],"Environment":["${{ env.ENVIRONMENT }}"]}' \
              --region "${{ env.AWS_REGION }}"













