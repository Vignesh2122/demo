name: Secure CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  issues: write  # Required to create GitHub issues

jobs:
  security-checks:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create reports folder
        run: mkdir -p security-reports

      # --- Dependency Review ---
      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
        continue-on-error: true

      # --- CodeQL ---
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript  # Change as needed

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # --- Build Docker Image ---
      - name: Build Docker Image
        run: docker build -t secure-app:latest .

      # --- Trivy Scan (HTML + JSON) ---
      - name: Trivy Scan
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -
          ./trivy image --format json -o security-reports/trivy.json secure-app:latest || true
          ./trivy image --format template --template "@contrib/html.tpl" \
            -o security-reports/trivy-report.html secure-app:latest || true

      # --- TruffleHog Secret Scan ---
      - name: TruffleHog Scan
        run: |
          pip install trufflehog
          trufflehog git file://. --json > security-reports/trufflehog.json || true

      # --- Generate Markdown Issue Summary ---
      - name: Generate Issue Body
        run: |
          echo "## 🔐 Security Scan Report – Run #${{ github.run_number }}" > issue-body.md
          echo "" >> issue-body.md

          if [ -f security-reports/trivy.json ]; then
            echo "### 🐳 Docker Vulnerabilities (Trivy)" >> issue-body.md
            jq -r '.Results[]?.Vulnerabilities[]? | "- **\(.Severity)**: \(.PkgName) – \(.VulnerabilityID): \(.Title)"' security-reports/trivy.json >> issue-body.md || echo "No vulnerabilities found" >> issue-body.md
          else
            echo "- Trivy report missing." >> issue-body.md
          fi

          echo "" >> issue-body.md

          if [ -f security-reports/trufflehog.json ]; then
            echo "### 🔑 Secrets Detected (TruffleHog)" >> issue-body.md
            jq -r '.[] | "- \(.DetectorName): found in \(.SourceMetadata.Data.Filename)"' security-reports/trufflehog.json >> issue-body.md || echo "No secrets found" >> issue-body.md
          else
            echo "- TruffleHog report missing." >> issue-body.md
          fi

          echo "" >> issue-body.md
          echo "_Full HTML report attached as artifact._" >> issue-body.md

      # --- Create GitHub Issue ---
      - name: Create GitHub Issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "🔐 Security Scan Report - Run #${{ github.run_number }}"
          content-filepath: issue-body.md
          labels: security, automated-scan

      # --- Upload Reports as Artifact ---
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
