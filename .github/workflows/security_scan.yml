name: Secret Scan with Gitleaks

on:
  push:
    branches: ['main']     # All branches
  pull_request:
    branches: ['**']     # All PRs to all branches

jobs:
  secret-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gitleaks Scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --no-git --exit-code 1 --verbose

      - name: Create GitHub Issue if secrets found
        if: failure()  # Only runs if previous step fails (secrets found)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "üîê Secret Detected in CI Pipeline" \
            --body "Secrets were detected in the recent commit.\n\nPlease review the code and rotate the affected credentials.\n\nThis issue was automatically created by Gitleaks." \
            --repo ${{ github.repository }}

      - name: Fail Pipeline
        if: failure()
        run: exit 1
