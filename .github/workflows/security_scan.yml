name: Full deployment workflow with security scan

on:
  push:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  issues: write

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: <your-account>.dkr.ecr.us-east-1.amazonaws.com  # Replace with your ECR registry
  SSM_DOCUMENT_NAME: YourSSMDocument                            # Replace with your SSM document
  INSTANCE_ID: i-xxxxxxxxxxxxxxxxx                              # Replace with actual EC2 instance ID
  ENVIRONMENT: production
  IMAGE_TAG: ${{ github.run_number }}

jobs:

  # -------------------------------
  # üîí Stage 1: Security Scan
  # -------------------------------
  security-scan:
    name: Security Scans (Gitleaks, CodeQL, Dependency Review)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v3
        with:
          scan-mode: all
          report-format: sarif
          report-path: gitleaks.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Gitleaks SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
        continue-on-error: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # -------------------------------
  # ‚öôÔ∏è Stage 2: Build & Push Docker Image + Scan
  # -------------------------------
  build:
    name: Build & Push Docker Image + Trivy Scan
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::674845781849:role/github  # Replace with your IAM role ARN
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag, and Push Docker Image
        run: |
          docker build -t dashboard:${{ github.run_number }} .
          docker tag dashboard:${{ github.run_number }} $ECR_REGISTRY/dashboard:${{ github.run_number }}
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
          docker push $ECR_REGISTRY/dashboard:${{ github.run_number }}

      - name: Trivy Scan on Image
        uses: aquasecurity/trivy-action@v0.4.0
        with:
          image-ref: $ECR_REGISTRY/dashboard:${{ github.run_number }}
          format: sarif
          output: trivy-scan.sarif
          severity-threshold: HIGH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-scan.sarif

  # -------------------------------
  # üöÄ Stage 3: Deploy to EC2 via SSM
  # -------------------------------
  deploy:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::674845781849:role/github
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2 Instance via SSM
        run: |
          aws ssm send-command \
            --document-name "${{ env.SSM_DOCUMENT_NAME }}" \
            --targets "Key=instanceids,Values=${{ env.INSTANCE_ID }}" \
            --comment "Deploying application" \
            --parameters '{"ImageTag":["${{ env.IMAGE_TAG }}"],"Environment":["${{ env.ENVIRONMENT }}"]}' \
            --region "${{ env.AWS_REGION }}"
